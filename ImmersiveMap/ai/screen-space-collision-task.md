# Универсальный модуль коллизий в экранном пространстве

## Контекст
Сейчас коллизии для экранных прямоугольников считаются в `LabelCollision.metal` и связанной логике (`LabelCollisionCalculator`, `LabelCollisionPipeline`, `LabelScreenCompute`). Логика жёстко привязана к лэйблам: использует `LabelInput`, `LabelRuntimeState`, учитывает `duplicate/isRetained` и обновляет альфу/transition.

Нужно сделать универсальный модуль для коллизий экранных UI-элементов. В будущем через него будут проходить не только лэйблы.

## Цель
Сделать переиспользуемый GPU/CPU модуль коллизий в экранном пространстве, независимый от лэйблов. Он должен принимать список экранных прямоугольников и выдавать результат коллизий (например, видимость/пересечения), а специфическая логика (например, fade для текста) должна быть вынесена в отдельные шаги.

## Текущее состояние (факты)
- Коллизии рассчитываются в `ImmersiveMapFramework/Shaders/Label/LabelCollision.metal`.
- Шейдер использует `LabelInput` и `LabelRuntimeState` из `ImmersiveMapFramework/Shaders/Common.h`.
- Коллизии запускаются из `LabelCollisionCalculator.run(...)` после вычисления экранных координат в `GlobeLabelScreenCompute` и `FlatLabelScreenCompute`.
- В шейдере коллизий одновременно:
  - вычисляется видимость,
  - обновляется fade/alpha (`LabelState`),
  - учитывается `duplicate`.

## Предварительное предложение по архитектуре
1) **Выделить универсальный контракт коллизий** (на уровне shader + Swift):
   - Input: позиция на экране, размеры (или halfSize), опционально приоритет/слой.
   - Output: видимость и/или список коллизий (формат уточнить).
2) **Отделить лэйбл-специфику**:
   - Логика `LabelState` (fade, duplicate, isRetained) не должна быть частью универсального шейдера коллизий.
   - Обновление `LabelState` — отдельный шаг после коллизий.
3) **Перевести существующий пайплайн на новый модуль**:
   - `LabelCollisionPipeline/Calculator` заменить на универсальные `ScreenCollisionPipeline/Calculator`.
   - Существующие лэйблы должны продолжить работать через адаптер.

## Минимальный набор требований (подтверждено)
- Работает в пикселях.
- Базовый тип: AABB прямоугольники.
- Доп. тип: окружности с радиусом (если без заметной потери производительности).
- Порядок входных данных определяет приоритет: первый в списке важнее.
- Возвращает бит видимости для каждого элемента.
- Производительность: O(N^2) допустима сейчас, интерфейс должен позволять оптимизации позже.
- Модуль коллизий не хранит состояние и не занимается анимациями.
- Клиппинг за экраном делает другой шейдер.

## Целевое API (подтверждено)
- Единый буфер входов с типом фигуры (rect/circle).

## Риски
- Слишком тесная связь с лэйблами приведёт к сложным миграциям позже.
- Если нужны сложные типы коллизий, AABB может быть недостаточно.

## Результат для внедрения (ожидается)
- Новый универсальный модуль коллизий экранных элементов.
- Лэйблы используют новый модуль через адаптер.
- Старый `LabelCollision` либо удалён, либо оставлен только как thin wrapper.
